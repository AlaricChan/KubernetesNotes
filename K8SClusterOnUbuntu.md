# Install Kubernetes Cluster on Ubuntu 16.04



# Prerequisite

* Docker-CE installed.
* No Ubuntu 14.04 ! ( Ubuntu 14.04 is not supported. )


# Steps

## 1.Install k8s tools ( Both on  K8S Master & K8S Minions(slave)) 

* 1.1 add GPG key
```curl https://packages.cloud.google.com/apt/doc/apt-key.gpg --insecure | sudo apt-key add -```


* 1.2. add debian source

Add below line into : /etc/apt/sources.list.d/kubernetes.list
`vim /etc/apt/sources.list.d/kubernetes.list`
#add line below
```deb http://apt.kubernetes.io/ kubernetes-xenial main ```

* 1.3. add Google CA , otherwise, you can't successfully apt-get update from k8s debian repo
```
sudo su
echo -n | openssl s_client -showcerts -connect storage.googleapis.com:443 2>/dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /usr/local/share/ca-certificates/googleapis.crt
update-ca-certificates
```

* 1.4. Install K8S tools
```
apt-get update
apt-get install -y kubelet kubeadm kubectl kubernetes-cni
```

* 1.5:  disable swap
```
sudo swapoff -a
```

* 1.6 Check service running (using `journalctl -u kubelet` to debug if failure)
```
service  kubelet status
```

##  2.Init Master

2.1 init
```
sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address $YOUR_VM_IP
```

2.2. copy config file
```
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
```

2.3. Deploy K8S Internal Network
```
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/k8s-manifests/kube-flannel-rbac.yml
```

2.4. ensure master running well
```
kubectl get nodes

# check if master node is "Ready"
#NAME            STATUS    ROLES     AGE       VERSION
#concourse       Ready     master    1d        v1.10.1
```


2.5.get Master  token (for later usage)
```
sudo kubeadm token list
```
Output is like below (the `0bs9tn.2ul*****4echpwo` is the token )
```
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
0bs9tn.2ul*****4echpwo   <invalid>   2018-04-24T09:46:13Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```


2.6. get Master CA Hash (for later usage)
```
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
```


## 3.Add a Slave (Minions)
goes to the Minions node (NOTE: the $CA_HASH & $TOKEN were retrieved in above steps)
```
kubeadm join --token $TOKEN  --discovery-token-ca-cert-hash sha256:$CA_HASH     $MASTER_IP:6443
```

goes back to master node, check minions until it's ready( it will take a while to docker pull/docker run some K8S service images)


```
kubectl get nodes
NAME            STATUS    ROLES     AGE       VERSION
myMaster    Ready     master    1d        v1.10.1
myMinions   Ready     <none>    1d        v1.10.1

```



## 4. K8S Dashboard

On your Master node:

4.1 Download dashboard deployment config file
```
wget https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml
```

4.2 modify the yaml , to add your IP as below (otherwise, you will need `kubectl proxy` or other way to access the dashboard remotely...)
```
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kube-system
spec:
  externalIPs:             ## newly added
    - 10.**.**.218         ## newly added your master public accessible IP
  ports:
    - port: 443
      targetPort: 8443
  selector:
    k8s-app: kubernetes-dashboard
```

4.3 install dashboard
```
kubectl create -f kubernetes-dashboard.yaml
```

4.4 Check from your web browser (Chrome may reject due to certification issue. Firefox will be a quick workaround)


4.5 Get API token from master (It's the same API token when we access K8S rest API). 
```
TOKEN=$(kubectl describe secret $(kubectl get secrets | grep default | cut -f1 -d ' ') | grep -E '^token' | cut -f2 -d':' | tr -d '\t')
```
4.6 Login "Token" on webpage with that, But you are not able to see anything without privilege. That's due to above `default` user doesn't have enough privilege.

4.7 Create an "admin" role
```
kubectl create -f https://raw.githubusercontent.com/rootsongjc/kubernetes-handbook/master/manifests/dashboard-1.7.1/admin-role.yaml
```

4.8 Obtain admin token, Login webpage with this token, and you are all set
```
kubectl -n kube-system describe secret `kubectl -n kube-system get secret|grep admin-token|cut -d " " -f1`|grep "token:"|tr -s " "|cut -d " " -f2
```



#  FAQ
1. 
Q: When if master node is restarted (or docker service restarted ), error pops up : 
```
error: Couldn't get available api versions from server: Get https://10.62.**.**:6443/api: dial tcp 10.62.**.**:6443: getsockopt: connection refused
```
A:  (1) Check if k8s services contains are running, especially the k8s_kube-apiserver. if not ,restart OS again

```
docker ps |grep k8s_kube-apiserver
90efa21fcc65        9df3c00f55e6                 "kube-apiserver --..."   18 hours ago        Up 18 hours                             k8s_kube-apiserver_kube-apiserver-concourse_kube-system_a0f3fb93ec00ebb37eb76cef1c833872_2
```
 (2) if services are running well,  override the old config again

```
rm $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
```

2.
Q: when re-init the k8s master

A: beside the `sudo kubeadm reset` & `sudo kubeadm init .....`. Don't forget to do the config copying and flannel installation steps.

3.

Q: based on my own experience. don't make master joining the workload (by changing master taint),

A: it will makes k8s service unstable (and insecute )

4.
Q: when query k8s system pod/deploy/service, example : `kubectl get deploy kubernetes-dashboard`  :    
`Error:   Error from server (NotFound): deployments.extensions "kubernetes-dashboard" not found`
A:that's because default namespace is "default", specify ns clearly to pointing kube-system         :
`kubectl get deploy kubernetes-dashboard --namespace=kube-system`


5.
Q: Debugging Tips 

A:
 1.  "kubecel describe" to check the last event
```
kubectl describe po kubernetes-dashboard-7d5dcdb6d9-cbph5 --namespace=kube-system
```

2. check system kubelet logs
```
sudo journalctl -u kubelet
```

3. Step in and Check container 
```
kubectl logs  $POD -c $ContainerName
kubectl exec -it $POD  -c $ContainerName  -- /bin/bash
```


Q: Volume Binding
```
Error:Unable to create a persistent volume with a default storage class
```
A:Check the PVC StorageClassName aligns PV

Q:even previous PVC deleted,  a new PVC can't claim and bind to a PV:     
```Error :    storageclass.storage.k8s.io "manual" not found```
A: PV default recycle strategy is "Retain", even previous PVC deleted, but its data still persist , and PV still occupied. you can delete/re-create that PV.



Q: mysql issue in toturial : https://kubernetes.io/docs/tasks/run-application/run-single-instance-stateful-application/
ERROR 1130 (HY000): Host '10.244.1.39' is not allowed to connect to this MySQL server

A: Check https://github.com/kubernetes/website/issues/8152



# Reference:

https://www.techrepublic.com/article/how-to-quickly-install-kubernetes-on-ubuntu/

https://mritd.me/2016/11/30/set-up-kubernetes-cluster-by-flannel/
